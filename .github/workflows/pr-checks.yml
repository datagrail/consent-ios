name: PR Checks

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    name: Build & Test
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.0'

      - name: Build
        run: swift build -v

      - name: Test
        run: swift test --enable-code-coverage

      - name: Generate coverage report
        run: |
          BIN_PATH=$(swift build --show-bin-path)
          XCTEST_PATH=$(find "$BIN_PATH" -name '*.xctest' -type d | head -1)
          if [ "$(uname)" = "Darwin" ]; then
            EXEC_PATH="$XCTEST_PATH/Contents/MacOS/$(basename "$XCTEST_PATH" .xctest)"
          else
            EXEC_PATH="$XCTEST_PATH"
          fi
          xcrun llvm-cov export \
            "$EXEC_PATH" \
            -instr-profile="$(find .build -name 'default.profdata' -type f | head -1)" \
            -format=lcov > coverage.lcov

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage.lcov
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  swiftlint:
    name: SwiftLint
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Lint
        run: swiftlint lint --strict

  uikit-tests:
    name: UIKit Tests (iOS Simulator)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.0'

      - name: Run UIKit Tests on iOS Simulator
        run: |
          # Show all available destinations for debugging
          echo "All available destinations:"
          xcodebuild -showdestinations -scheme DataGrailConsent 2>&1 | grep -E "(platform|Ineligible)"

          # Get the first available iPhone simulator from xcodebuild's supported destinations
          SIMULATOR=$(xcodebuild -showdestinations -scheme DataGrailConsent 2>&1 | \
            grep "platform:iOS Simulator" | \
            grep -i "iPhone" | \
            grep -v "Any iOS" | \
            head -1 | \
            sed -E 's/.*name:([^,}]+).*/\1/' | \
            xargs)

          # If no iPhone found, try any iOS Simulator (iPad, etc)
          if [ -z "$SIMULATOR" ]; then
            echo "No iPhone simulator found, trying any iOS Simulator device..."
            SIMULATOR=$(xcodebuild -showdestinations -scheme DataGrailConsent 2>&1 | \
              grep "platform:iOS Simulator" | \
              grep -v "Any iOS" | \
              head -1 | \
              sed -E 's/.*name:([^,}]+).*/\1/' | \
              xargs)
          fi

          if [ -z "$SIMULATOR" ]; then
            echo "Error: No iOS Simulator found!"
            exit 1
          fi

          echo "Using simulator: $SIMULATOR"

          xcodebuild test \
            -scheme DataGrailConsent \
            -destination "platform=iOS Simulator,name=$SIMULATOR" \
            -enableCodeCoverage YES

      - name: Upload UIKit coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          flags: uikit-tests
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  pod-lint:
    name: Podspec Validation
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate podspec
        run: pod lib lint --allow-warnings
