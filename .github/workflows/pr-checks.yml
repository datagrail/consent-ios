name: PR Checks

on:
  pull_request:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    name: Build & Test
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.0'

      - name: Build
        run: swift build -v

      - name: Test
        run: swift test --enable-code-coverage

      - name: Generate coverage report
        run: |
          BIN_PATH=$(swift build --show-bin-path)
          XCTEST_PATH=$(find "$BIN_PATH" -name '*.xctest' -type d | head -1)
          if [ "$(uname)" = "Darwin" ]; then
            EXEC_PATH="$XCTEST_PATH/Contents/MacOS/$(basename "$XCTEST_PATH" .xctest)"
          else
            EXEC_PATH="$XCTEST_PATH"
          fi
          xcrun llvm-cov export \
            "$EXEC_PATH" \
            -instr-profile="$(find .build -name 'default.profdata' -type f | head -1)" \
            -format=lcov > coverage.lcov

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage.lcov
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  swiftlint:
    name: SwiftLint
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Lint
        run: swiftlint lint --strict

  uikit-tests:
    name: UIKit Tests (iOS Simulator)
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.0'

      - name: Run UIKit Tests on iOS Simulator
        run: |
          # List available simulators
          echo "Available iPhone simulators:"
          xcrun simctl list devices available iPhone | head -10 || true

          # Get first available iPhone simulator UUID
          SIMULATOR_ID=$(xcrun simctl list devices available iPhone | \
            grep -m 1 "iPhone" | \
            sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')

          if [ -z "$SIMULATOR_ID" ]; then
            echo "Error: No iPhone simulator found"
            exit 1
          fi

          echo "Using simulator ID: $SIMULATOR_ID"

          # Use simulator ID directly as destination
          xcodebuild test \
            -scheme DataGrailConsent \
            -destination "platform=iOS Simulator,id=$SIMULATOR_ID" \
            -enableCodeCoverage YES

      - name: Upload UIKit coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          flags: uikit-tests
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  pod-lint:
    name: Podspec Validation
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate podspec
        run: pod lib lint --allow-warnings
